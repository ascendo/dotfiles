# Example prompt:
#
# 23:11:27 | 3s | (1) | %0 | !5232
# user@host:/tmp
# $

timer_start () { : ${timer=$SECONDS}; }

timer_stop  () {
    local _RUNTIME=$(($SECONDS - $timer))
    unset timer

    # Convert seconds to hms.
    _RUNTIME_FORMATTED=
    [[ $_RUNTIME -gt 3600 ]] && _RUNTIME_FORMATTED+=$(($_RUNTIME / 3600))h
    [[ $_RUNTIME -gt 60 ]]   && _RUNTIME_FORMATTED+=$(($_RUNTIME % 3600 / 60))m
    [[ $_RUNTIME -gt 0 ]]    && _RUNTIME_FORMATTED+=$(($_RUNTIME % 60))s
    : ${_RUNTIME_FORMATTED:=0s}
}

trap 'timer_start' DEBUG
PROMPT_COMMAND='_exit_status_color; '$PROMPT_COMMAND' timer_stop;'

_exit_status_color () {
    if [[ 0 -eq $? ]]; then
        _EXIT_STATUS_FORMATTED=${ANSI_BOLD}${ANSI_GREEN}
    else
        _EXIT_STATUS_FORMATTED=${ANSI_BOLD}${ANSI_RED}
    fi
}

if [[ -n $SSH_CLIENT ]]; then
    _HOST_FORMATTED='${ANSI_YELLOW}\h${ANSI_RESET}'
else
    _HOST_FORMATTED='\h'
fi

PS1='\[${ANSI_RESET}\]'

# Set the terminal title.
PS1=$PS1'\[\e]0;\w\a\]'

PS1=$PS1'\n\t | ${_RUNTIME_FORMATTED} | (${SHLVL}) | %\j | !\!'
PS1=$PS1'\n\u@'${_HOST_FORMATTED}':\[${ANSI_CYAN}\]\w\[${ANSI_RESET}\]'
PS1=$PS1'\n\[${_EXIT_STATUS_FORMATTED}\]\$\[${ANSI_RESET}\] '
export PS1

for v in RUNTIME EXIT_STATUS HOST; do
    unset _${v}_FORMATTED
done
